// ScreenRenderer for Bloxd.io
// Copyright (c) 2026 the_ccccc
// Licensed under the BSD 3-Clause License.
const font8x8={0:[60,66,66,66,66,66,66,60],1:[16,48,80,16,16,16,16,124],2:[60,66,2,4,8,16,32,126],3:[60,66,2,28,2,2,66,60],4:[8,24,40,72,126,8,8,8],5:[126,64,64,124,2,2,66,60],6:[60,64,64,124,66,66,66,60],7:[126,2,4,8,16,16,16,16],8:[60,66,66,60,66,66,66,60],9:[60,66,66,62,2,2,64,60],A:[24,60,102,102,126,102,102,102],B:[124,102,102,124,102,102,102,124],C:[60,102,96,96,96,96,102,60],D:[120,108,102,102,102,102,108,120],E:[126,96,96,120,96,96,96,126],F:[126,96,96,120,96,96,96,96],G:[60,102,96,96,110,102,102,60],H:[102,102,102,126,102,102,102,102],I:[60,24,24,24,24,24,24,60],J:[6,6,6,6,6,102,102,60],K:[102,108,120,112,120,108,102,102],L:[96,96,96,96,96,96,96,126],M:[99,119,127,107,99,99,99,99],N:[99,99,99,115,123,111,103,99],O:[60,102,102,102,102,102,102,60],P:[124,102,102,124,96,96,96,96],Q:[60,102,102,102,102,106,108,54],R:[124,102,102,124,120,108,102,102],S:[60,102,96,60,6,6,102,60],T:[126,126,24,24,24,24,24,24],U:[102,102,102,102,102,102,102,60],V:[102,102,102,102,102,102,60,24],W:[99,99,99,107,127,119,99,99],X:[102,102,60,24,60,102,102,102],Y:[102,102,102,60,24,24,24,24],Z:[126,6,12,24,48,96,192,126],a:[0,0,60,2,62,70,70,58],b:[96,96,92,98,98,98,98,92],c:[0,0,60,66,96,96,66,60],d:[2,2,58,70,70,70,70,58],e:[0,0,60,66,126,96,66,60],f:[12,18,16,62,16,16,16,16],g:[0,0,0,60,64,78,66,60],h:[96,96,92,98,98,98,98,98],i:[24,0,56,24,24,24,24,60],j:[6,0,6,6,6,6,102,60],k:[96,96,100,104,112,104,100,98],l:[56,24,24,24,24,24,24,60],m:[0,0,102,127,127,107,99,99],n:[0,0,92,98,98,98,98,98],o:[0,0,60,66,66,66,66,60],p:[0,0,120,68,68,120,64,64],q:[0,0,0,60,66,66,74,61],r:[0,0,92,98,96,96,96,96],s:[0,0,60,96,60,6,6,60],t:[16,16,62,16,16,16,20,24],u:[0,0,66,66,66,66,70,58],v:[0,0,66,66,66,66,36,24],w:[0,0,66,66,90,90,102,102],x:[0,0,66,36,24,24,36,66],y:[0,0,66,66,66,58,4,56],z:[0,0,126,4,8,16,32,126]," ":[0,0,0,0,0,0,0,0],"!":[24,24,24,24,24,0,24,0],'"':[102,102,0,0,0,0,0,0],"#":[36,36,126,36,36,126,36,36],$:[24,60,88,56,28,26,60,24],"%":[96,102,12,24,48,102,6,0],"&":[60,102,56,96,105,102,60,0],"'":[24,24,8,0,0,0,0,0],"(":[12,24,48,48,48,48,24,12],")":[48,24,12,12,12,12,24,48],"*":[0,102,60,255,60,102,0,0],"+":[0,24,24,126,24,24,0,0],",":[0,0,0,0,0,0,24,48],"-":[0,0,0,126,0,0,0,0],".":[0,0,0,0,0,0,24,24],"/":[0,2,4,8,16,32,64,0],":":[0,0,24,24,0,24,24,0],";":[0,0,24,24,0,24,24,48],"<":[6,24,96,96,96,24,6,0],"=":[0,0,126,0,0,126,0,0],">":[96,24,6,6,6,24,96,0],"?":[60,102,6,12,24,0,24,0],"@":[60,66,154,170,170,158,64,60],"[":[30,24,24,24,24,24,24,30],"\\":[0,64,32,16,8,4,2,0],"]":[120,24,24,24,24,24,24,120],"^":[8,28,54,99,0,0,0,0],_:[0,0,0,0,0,0,0,255],"{":[12,24,24,48,24,24,12,0],"|":[24,24,24,24,24,24,24,24],"}":[48,24,24,12,24,24,48,0],"~":[0,118,220,0,0,0,0,0]};function deleteScreen(e){const t=globalThis.activeScreens.get(e);t&&t.delete()}globalThis.activeScreens=new Map;class Screen{constructor(e,t,i,s="default",h=!1){this.playerId=e,this.screenId=t,this.screenPos=i;let r={};"default"===s?r={colorMap:{red:"ðŸŸ¥",orange:"ðŸŸ§",yellow:"ðŸŸ¨",green:"ðŸŸ©",blue:"ðŸŸ¦",purple:"ðŸŸª",brown:"ðŸŸ«",black:"â¬›",white:"â¬œ"}}:"bw"===s?r={colorMap:{black:"â¬›",white:"â¬œ"}}:"object"==typeof s&&(r=s),this.width=r.width||285,this.height=r.height||125,this.alwaysRender=r.alwaysRender||h,this.pixelStep=.03,this.batchSize=10,this.palette=[],this.colorToIndex={};const n=r.colorMap||{black:"â¬›",white:"â¬œ"};"black"in n||(n.black="â¬›"),"white"in n||(n.white="â¬œ");let o=0;for(const[e,t]of Object.entries(n))this.palette.push(t),this.colorToIndex[e]=o,o++;this.colorToIndex[0]=this.colorToIndex.black,this.colorToIndex[1]=this.colorToIndex.white,this.fallbackIndex=this.colorToIndex.black,this.buffer=new Uint8Array(this.width*this.height),this.buffer.fill(this.fallbackIndex),this.rowBuilder=new Array(this.width),this.renderPointer=0,this.isRendering=!1,globalThis.activeScreens.set(this.screenId,this)}_getColorIndex(e){const t=this.colorToIndex[e];return void 0!==t?t:this.fallbackIndex}fill(e){this.buffer.fill(this._getColorIndex(e)),this.alwaysRender&&this.render()}setPixel(e,t,i){e>=0&&e<this.width&&t>=0&&t<this.height&&(this.buffer[t*this.width+e]=this._getColorIndex(i)),this.alwaysRender&&this.render()}drawText(e,t,i,s=0,h="white"){const r=this._getColorIndex(h);let n=t;for(let t=0;t<e.length;t++){const h=e[t],o=font8x8[h]||font8x8["?"];for(let e=0;e<8;e++){const t=o[e];for(let s=0;s<8;s++)if(t&1<<7-s){const t=n+s,h=i+e;t>=0&&t<this.width&&h>=0&&h<this.height&&(this.buffer[h*this.width+t]=r)}}n+=8+s}this.alwaysRender&&this.render()}render(){this.renderPointer=0,this.isRendering=!0}onTick(){if(!this.isRendering)return;let e=0;for(;e<this.batchSize&&this.renderPointer<this.height;)this._renderRow(this.renderPointer),this.renderPointer++,e++;this.renderPointer>=this.height&&(this.isRendering=!1)}delete(){this.isRendering=!1;for(let e=0;e<this.height;e++){const t=this.height-1-e,i=`${this.screenId}_${t}`;api.clearDirectionArrow(this.playerId,i)}globalThis.activeScreens.delete(this.screenId)}_renderRow(e){const t=e*this.width;for(let e=0;e<this.width;e++)this.rowBuilder[e]=this.palette[this.buffer[t+e]];const i=this.rowBuilder.join(""),s=this.height-1-e,h=[this.screenPos[0],this.screenPos[1]+s*this.pixelStep,this.screenPos[2]];api.setDirectionArrow(this.playerId,`${this.screenId}_${s}`,h,i,!1,{color:"black",fontSize:"4px"})}};function tick(){for(const c of globalThis.activeScreens.values())c.onTick()}
